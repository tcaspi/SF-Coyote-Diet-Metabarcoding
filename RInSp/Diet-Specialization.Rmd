---
title: "Diet-Specialization"
author: "Tali Caspi"
date: "2024-11-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(RInSp)
library(mgcv)
library(ggrepel)

# Set custom plot theme
theme_custom <- function() {
  theme_classic() +
  theme(panel.grid.minor = element_blank(),
        plot.background = element_rect(fill = "white", color = NA),
        strip.background = element_rect(fill = "grey80", color = NA),
        axis.text.y = element_text(size=10),
        axis.text.x = element_text(size=10),
        axis.title.y = element_text(size=12),
        axis.title.x = element_text(size=12))}
```

# Prepare data

```{r}
# Load diet data
sp.RRA <- read.csv("Filtering-and-QC/sp.RRA.clean.csv") %>% select(-c(X))
func.RRA <- read.csv("Filtering-and-QC/func.RRA.clean.csv") %>% select(-c(X))

# Load covariate data
covs <- read.csv("Regression-Analyses/Territory_All_Covariates.csv")

# Load family group data
fams <- read.csv("Diet-Plots/IDs.csv")

# Make sample list
sample_list <- rawseqs.clean %>% select(SampleID)

# Load metadata, add territories, seasons, and select relevant columns
metadata <- read.csv("Filtering-and-QC/All_Metadata.csv") %>% 
  
  # Add territories 
  mutate(Territory = case_when(
    Site == "BERN" | Site == "STMA" ~ "Bernal",
    Site == "GLEN" | Site == "LAGU" | Site == "TWIN" | Site == "MTDA" | Site == "GGHP" ~ "Glen",
    Site == "SFGC" | Site == "OLYM" | Site == "LAKE" | Site == "FTFU" ~ "Merced",
    Site == "BVP" | Site == "CHP" ~ "Corona",
    Site == "TGPH" | Site == "HYDE" | Site == "FORT" ~ "Coit",
    Site == "GGPE" ~ "GGP - East",
    Site == "GGPW" | Site == "GGP" ~ "GGP - West",
    Site == "LEND" | Site == "LAFY" ~ "Land's End",
    Site == "MCLA" ~ "McLaren",
    Site == "PRES" ~ "Presidio",
    Site == "STFA" ~ "St. Francis",
    Site == "SUNS" ~ "Sunset Res",
    Site == "STGV" ~ "Stern Grove")) %>% 
  
  # Add biological seasons
  mutate(Biol.Season = case_when(
    Month == 3 | Month == 4 | Month == 5 | Month == 6 ~ "Pupping",
    Month == 7 | Month == 8 | Month == 9 | Month == 10 ~ "Dispersal",
    Month == 11 | Month == 12 | Month == 1 | Month == 2 ~ "Mating")) %>% 
  
  # Select only relevant columns
  select(c(SampleID, Biol.Season, Territory, Category, Individual)) %>%
  
  # Only retain metadata for samples in the final diet data frame
  inner_join(sample_list, by = "SampleID") %>% 
  
  # Turn character columns to factors
  mutate(Biol.Season = as.factor(Biol.Season),
         Territory = as.factor(Territory),
         Category = as.factor(Category),
         Individual = as.factor(Individual))
```

# Population BIC/TNW

The code below calculates the average relative read abundance per diet item per individual and transforms these proportions to integers by multiplying by 1,000 and rounding to the nearest whole number. Accordingly, these integer data reflect the relative read abundances ascribed to each individual. Then, BIC/TNW is calculated for the population.

```{R}
# Create data frame of averaged RRA values per individual and convert to integers
geno_RRA <- inner_join(metadata, sp.RRA, by = "SampleID") %>% 
  filter(Category == "SFCoy") %>% # only include scats with individual IDs 
  group_by(Individual) %>% 
  summarize(across(where(is.numeric), ~ round(mean(.) * 1000)))  %>% # multiply by 1000 & round to nearest whole number
  mutate(ID = seq(1, nrow(.))) %>% 
  relocate(ID, .before = Individual) %>% 
  left_join(fams, by="Individual") %>% # add individual family group assignments
  relocate(Family.Group, .after=ID) %>% 
  relocate(Sex, .after = Family.Group) %>% 
  mutate(FamID = as.factor(Family.Group), .before=Family.Group) %>% 
  as.data.frame()

# Create RInSp object
rinsp_geno_RRA = import.RInSp(geno_RRA, row.names = 1, data.type = "integer", info.cols = c(2:5))

# WIC/TNW
WT_geno_RRA = WTdMC(rinsp_geno_RRA, replicates=999, print.ris=TRUE, pop.diet = "average")

# BIC/TNW
pop_BIC.TNW <- 1-WT_geno_RRA$WonT
```

# Territory-level BIC/TNW

The code below calculates BIC/TNW for each family group of coyotes. Given that diets are relatively consistent within territories, we expect to find that between-individual differences explain less of the dietary variation within family groups relative to the entire population.

```{r}
# Define sites to drop (not permanent territories)
sites.to.drop <- c("Stern Grove", "Sunset Res")

# Define a function to process each territory
process_familygroup <- function(family_name) {
  # Filter, group, summarize, and format data
  geno_data <- inner_join(metadata, sp.RRA, by = "SampleID") %>%
    left_join(fams, by="Individual") %>% 
    filter(Category == "SFCoy", Family.Group == family_name) %>%
    group_by(Individual) %>%
    summarize(across(where(is.numeric), ~ round(mean(.) * 10000))) %>%
    mutate(ID = seq(1, nrow(.))) %>%
    relocate(ID, .before = Individual) %>%
    as.data.frame()
  
  # Get count of number of individuals included per territory
  row_count <- nrow(geno_data)
  
  # Create RInSp object
  rinsp_obj <- import.RInSp(geno_data, row.names = 1, data.type = "integer", info.cols = 2)
  
  # Calculate WIC/TNW index
  WT_result <- WTdMC(rinsp_obj, replicates = 999, print.ris = TRUE, pop.diet = "average")
  
  # Return results for WonT and p-value
  list(Family.Group = family_name, WIC.TNW = WT_result$WonT, p_value = WT_result$p.value,
       Num.Ind = row_count)
}

# Get unique family group names
unique_fams <- unique(fams$Family.Group)

# Apply the function to each family group and store results
results <- map(unique_fams, process_familygroup)

# Calculate the number of scats used in each family group
territory_counts <- inner_join(metadata, sp.RRA, by = "SampleID") %>%
    left_join(fams, by="Individual") %>% 
    filter(Category == "SFCoy") %>% 
    filter(Family.Group != "Transient") %>% 
    group_by(Family.Group) %>% 
    mutate(Num.Scats = n()) %>% 
    relocate(Family.Group, .after = SampleID) %>% 
    relocate(Num.Scats, .after = Family.Group) %>% 
    distinct(Family.Group, Num.Scats)

# Convert list of results to a data frame and add covariate data
results_df <- bind_rows(results) %>% 
  mutate(BIC.TNW = 1-WIC.TNW, .after=WIC.TNW) %>% 
  filter(Family.Group != "Transient") %>% # drop transient individual
  left_join(covs, by = c("Family.Group" = "Territory")) %>%  # join environmental covariates
  left_join(territory_counts, by="Family.Group") %>% 
  mutate(Fam.Names = case_when( # add custom family group names for plotting
    Family.Group == "Bernal" ~ "Bernal Hill",
    Family.Group == "Coit" ~ "Coit Tower",
    Family.Group == "Glen" ~ "Glen Canyon",
    Family.Group == "Corona" ~ "Corona Heights Park",
    Family.Group == "GGP - East" ~ "Golden Gate Park - East",
    Family.Group == "St. Francis" ~ "St. Francis Wood",
    Family.Group == "GGP - West" ~ "Golden Gate Park - West",
    Family.Group == "McLaren" ~ "McLaren Park",
    TRUE ~ Family.Group))

# View the results
arrange(results_df, BIC.TNW)
```

Model and plot results:
```{r}
# Model BIC/TNW as a function of ISA and number of scats
mod.BIC.ISA.beta.gam <- gam(BIC.TNW ~ ISA + Num.Scats, family=betar(link="logit"), data = results_df)
summary(mod.BIC.ISA.beta.gam)

# Generate new ISA and Num.Scats data for making predictions
new_data <- data.frame(ISA = seq(0, 100, by=0.1),
                       Num.Scats = round(mean(results_df$Num.Scats)))

# Make predictions on the link scale, calculate confidence interval boundaries on the link scale, then back transform using the inverse link to get boundaries on the response scale
gam_preds <- as.data.frame(mgcv::predict.gam(mod.BIC.ISA.beta.gam, newdata = new_data, se.fit = TRUE, type="link")) %>% 
  mutate(ISA = new_data$ISA, .before="fit") %>% 
  mutate(upr = fit + (1.96 * se.fit),
         lwr = fit - (1.96 * se.fit),
         BIC.TNW = mod.BIC.ISA.beta.gam$family$linkinv(fit),
         upr_adj = mod.BIC.ISA.beta.gam$family$linkinv(upr),
         lwr_adj = mod.BIC.ISA.beta.gam$family$linkinv(lwr))

# Plot BIC/TNW as a function of ISA
ggplot() +
  
  # Add regression line for predictions of BIC/TNW for each ISA value
  geom_smooth(data = gam_preds, aes(x = ISA, y = BIC.TNW,
                                   ymin = lwr_adj, ymax = upr_adj), stat = 'identity',
            color="#696464", fill="darkgrey", alpha=0.5, linewidth=0.5)+
  
  # Add population-level BIC/TNW
   geom_hline(yintercept=(geno_RRA_BIC/geno_RRA_TNW), linetype = "dashed")+
  
  # Add BIC/TNW values for each family group
  geom_point(data = results_df, aes(x = ISA, y = BIC.TNW), size=0.5)+
  
  # Add family group labels
  geom_text_repel(data = results_df, aes(x = ISA, y = BIC.TNW, label = Fam.Names),
                  size = 2,    # Smaller label size
                  segment.color = "grey50", segment.size = 0.3,
                  direction="both") +
  
  # Set graphics
  theme_custom()+
  ylab("BIC/TNW")+xlab("Impervious Surface Cover")+
  scale_x_continuous(limits=c(0,101), expand=c(0, 0))+
  scale_y_continuous(limits=c(0,1))

#ggsave("RInSp/BIC.TNW.plot.png", dpi=600, height=3, width=4)
```
